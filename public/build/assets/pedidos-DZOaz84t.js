document.addEventListener("DOMContentLoaded",function(){console.log("JavaScript de Pedidos cargado");const l=document.getElementById("dialog-completar"),o=document.getElementById("dialog-cancelar"),s=document.getElementById("dialog-error"),i=document.getElementById("dialog-success");document.getElementById("detailsModal"),document.getElementById("mis-pedidos-details-modal");const b=document.getElementById("btn-cerrar-completar"),v=document.getElementById("btn-cerrar-cancelar"),S=document.getElementById("btn-cerrar-error"),k=document.getElementById("btn-cerrar-success"),p=document.getElementById("btn-confirmar-completar"),y=document.getElementById("btn-confirmar-cancelar"),B=document.getElementById("mensaje-error"),I=document.getElementById("mensaje-success"),E=document.getElementById("user_search"),L=document.getElementById("user_id"),r=document.getElementById("user-suggestions");let m,c;function u(e){B&&s&&(B.textContent=e,s.showModal())}function h(e){I&&i&&(I.textContent=e,i.showModal())}if(E&&r){let e=null;E.addEventListener("input",function(){clearTimeout(e),e=setTimeout(()=>{const n=E.value.trim();if(n.length<2){r.innerHTML="",r.style.display="none";return}fetch(`/usuarios?search=${encodeURIComponent(n)}`,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error(`Error HTTP: ${t.status}`);return t.json()}).then(t=>{if(r.innerHTML="",t.data.length===0){r.innerHTML='<div class="suggestion-item">No se encontraron usuarios</div>',r.style.display="block";return}t.data.forEach(d=>{const f=document.createElement("div");f.className="suggestion-item",f.textContent=`${d.name||"No disponible"} (${d.email})`,f.dataset.userId=d.id,f.addEventListener("click",()=>{E.value=`${d.name||"No disponible"} (${d.email})`,L.value=d.id,r.innerHTML="",r.style.display="none"}),r.appendChild(f)}),r.style.display="block"}).catch(t=>{console.error("Error fetching users:",t),r.innerHTML='<div class="suggestion-item">Error al buscar usuarios</div>',r.style.display="block"})},300)}),document.addEventListener("click",function(n){!E.contains(n.target)&&!r.contains(n.target)&&(r.innerHTML="",r.style.display="none")})}document.querySelectorAll(".btn-completar").forEach(e=>{e.addEventListener("click",function(n){n.preventDefault(),m=this.getAttribute("data-id"),c=this.closest("tr"),l&&l.showModal()})}),document.querySelectorAll(".btn-cancelar").forEach(e=>{e.addEventListener("click",function(n){n.preventDefault(),m=this.getAttribute("data-id"),c=this.closest("tr"),o&&o.showModal()})}),document.querySelectorAll(".btn-detalles, .mis-pedidos-btn-detalles").forEach(e=>{e.addEventListener("click",function(n){n.preventDefault();const t=this.getAttribute("data-id");t?A(t):u("ID del pedido no encontrado.")})});const T=document.querySelector(".btn-crear-pedido");T&&T.addEventListener("click",function(e){e.preventDefault(),window.location.href="/pedidos/create"}),document.querySelectorAll("#create-order-form, #edit-order-form").forEach(e=>{e.addEventListener("submit",function(n){var f;n.preventDefault();const t=e.querySelector('button[type="submit"]');if(t&&(t.disabled=!0,t.textContent=e.id==="create-order-form"?"Creando pedido...":"Guardando cambios..."),!L.value){u("Por favor, selecciona un usuario."),t&&(t.disabled=!1,t.textContent=e.id==="create-order-form"?"Crear Pedido":"Guardar Cambios");return}const d=Array.from(e.querySelectorAll(".item-quantity")).map((a,g)=>{const C=e.querySelectorAll(".item-product")[g],$=parseInt(C.selectedOptions[0].dataset.stock),x=parseInt(a.value);return x>$?(u(`La cantidad para ${C.selectedOptions[0].text} excede el stock disponible (${$}).`),null):{product_id:C.value,quantity:x}});if(d.includes(null)){t&&(t.disabled=!1,t.textContent=e.id==="create-order-form"?"Crear Pedido":"Guardar Cambios");return}fetch(e.action,{method:((f=e.querySelector('input[name="_method"]'))==null?void 0:f.value)||e.method,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({user_id:e.querySelector("#user_id").value,items:d})}).then(a=>a.ok?a.json():a.text().then(g=>{throw new Error(`Error HTTP: ${a.status} - ${g}`)})).then(a=>{a.success?(h(a.success),setTimeout(()=>window.location.href="/pedidos",1e3)):(u(a.error||"No se pudo procesar el pedido."),t&&(t.disabled=!1,t.textContent=e.id==="create-order-form"?"Crear Pedido":"Guardar Cambios"))}).catch(a=>{console.error("Error:",a),u("Hubo un problema: "+a.message),t&&(t.disabled=!1,t.textContent=e.id==="create-order-form"?"Crear Pedido":"Guardar Cambios")})})});const q=document.getElementById("add-item");q&&q.addEventListener("click",function(){const e=document.querySelector("#items-table tbody"),n=e.children.length,t=document.createElement("tr");t.innerHTML=`
                <td>
                    <select name="items[${n}][product_id]" class="item-product">
                        ${Array.from(document.querySelector(".item-product").options).map(d=>`<option value="${d.value}" data-stock="${d.dataset.stock}">${d.text}</option>`).join("")}
                    </select>
                </td>
                <td>
                    <input type="number" name="items[${n}][quantity]" value="1" min="1" class="item-quantity">
                </td>
                <td>
                    <button type="button" class="btn-remove-item">Eliminar</button>
                </td>
            `,e.appendChild(t)}),document.addEventListener("click",function(e){e.target.classList.contains("btn-remove-item")&&document.querySelectorAll("#items-table tbody tr").length>1&&e.target.closest("tr").remove()}),p&&p.addEventListener("click",function(){p.disabled=!0,p.textContent="Procesando...",fetch(`/pedidos/${m}/complete`,{method:"PATCH",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.ok?e.json():e.text().then(n=>{throw new Error(`Error HTTP: ${e.status} - ${n}`)})).then(e=>{if(e.success){const n=c==null?void 0:c.querySelector(".status-cell"),t=c==null?void 0:c.querySelector("td:last-child");n&&(n.textContent="Completado"),t&&(t.innerHTML=`<button class="btn-detalles" data-id="${m}" aria-label="Ver detalles del pedido #${m}">Ver Detalles</button>`),l&&l.close(),h(e.success)}else u(e.error||"No se pudo completar el pedido.")}).catch(e=>{console.error("Error:",e),u("Hubo un problema: "+e.message)}).finally(()=>{p&&(p.disabled=!1,p.textContent="Sí")})}),y&&y.addEventListener("click",function(){y.disabled=!0,y.textContent="Procesando...",fetch(`/pedidos/${m}/cancel`,{method:"PATCH",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.ok?e.json():e.text().then(n=>{throw new Error(`Error HTTP: ${e.status} - ${n}`)})).then(e=>{if(e.success){const n=c==null?void 0:c.querySelector(".status-cell"),t=c==null?void 0:c.querySelector("td:last-child");n&&(n.textContent="Cancelado"),t&&(t.innerHTML=`<button class="btn-detalles" data-id="${m}" aria-label="Ver detalles del pedido #${m}">Ver Detalles</button>`),o&&o.close(),h(e.success)}else u(e.error||"No se pudo cancelar el pedido.")}).catch(e=>{console.error("Error:",e),u("Hubo un problema al cancelar el pedido: "+e.message)}).finally(()=>{y&&(y.disabled=!1,y.textContent="Sí")})}),b&&l&&b.addEventListener("click",()=>l.close()),v&&o&&v.addEventListener("click",()=>o.close()),S&&s&&S.addEventListener("click",()=>s.close()),k&&i&&k.addEventListener("click",()=>i.close())});function A(l){fetch(`/pedidos/${l}`,{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"text/html"}}).then(o=>{if(!o.ok)throw new Error("Error HTTP: "+o.status);return o.text()}).then(o=>{const s=document.getElementById("mis-pedidos-details-modal")||document.getElementById("detailsModal"),i=s.querySelector("#mis-pedidos-details-content")||document.getElementById("detailsContent"),b=s.querySelector("#mis-pedidos-pdf-link")||document.getElementById("pdfLink");i.innerHTML=o,b.href=`/pedidos/${l}/pdf`,s&&s.showModal()}).catch(o=>{console.error("Error al cargar detalles:",o);const s=document.getElementById("mensaje-error"),i=document.getElementById("dialog-error");s&&i&&(s.textContent="Error al cargar los detalles del pedido: "+o.message,i.showModal())})}
