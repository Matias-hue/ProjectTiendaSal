document.addEventListener("DOMContentLoaded",function(){console.log("JavaScript de Pedidos cargado");const a=document.getElementById("dialog-completar"),n=document.getElementById("dialog-cancelar"),l=document.getElementById("dialog-error"),i=document.getElementById("dialog-success");document.getElementById("detailsModal");const y=document.getElementById("btn-cerrar-completar"),b=document.getElementById("btn-cerrar-cancelar"),g=document.getElementById("btn-cerrar-error"),C=document.getElementById("btn-cerrar-success"),u=document.getElementById("btn-confirmar-completar"),m=document.getElementById("btn-confirmar-cancelar"),S=document.getElementById("mensaje-error"),v=document.getElementById("mensaje-success");let d,o;function s(e){S&&l&&(S.textContent=e,l.showModal())}function p(e){v&&i&&(v.textContent=e,i.showModal())}document.querySelectorAll(".btn-completar").forEach(e=>{e.addEventListener("click",function(t){t.preventDefault(),d=this.getAttribute("data-id"),o=this.closest("tr"),a&&a.showModal()})}),document.querySelectorAll(".btn-cancelar").forEach(e=>{e.addEventListener("click",function(t){t.preventDefault(),d=this.getAttribute("data-id"),o=this.closest("tr"),n&&n.showModal()})}),document.querySelectorAll(".btn-detalles").forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();const r=this.getAttribute("data-id");r?L(r):s("ID del pedido no encontrado.")})});const B=document.querySelector(".btn-crear-pedido");B&&B.addEventListener("click",function(e){e.preventDefault(),window.location.href="/pedidos/create"}),document.querySelectorAll("#create-order-form, #edit-order-form").forEach(e=>{e.addEventListener("submit",function(t){var f,q;t.preventDefault();const r=Array.from(e.querySelectorAll(".item-quantity")).map((c,E)=>{const h=e.querySelectorAll(".item-product")[E],I=parseInt(h.selectedOptions[0].dataset.stock),A=parseInt(c.value);return A>I?(s(`La cantidad para ${h.selectedOptions[0].text} excede el stock disponible (${I}).`),null):{product_id:h.value,quantity:A}});r.includes(null)||fetch(e.action,{method:((f=e.querySelector('input[name="_method"]'))==null?void 0:f.value)||e.method,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({user_id:(q=e.querySelector("#user_id"))==null?void 0:q.value,items:r})}).then(c=>c.ok?c.json():c.text().then(E=>{throw new Error(`Error HTTP: ${c.status} - ${E}`)})).then(c=>{c.success?(p(c.success),setTimeout(()=>window.location.href="/pedidos",1e3)):s(c.error||"No se pudo procesar el pedido.")}).catch(c=>{console.error("Error:",c),s("Hubo un problema: "+c.message)})})});const k=document.getElementById("add-item");k&&k.addEventListener("click",function(){const e=document.querySelector("#items-table tbody"),t=e.children.length,r=document.createElement("tr");r.innerHTML=`
                <td>
                    <select name="items[${t}][product_id]" class="item-product">
                        ${Array.from(document.querySelector(".item-product").options).map(f=>`<option value="${f.value}" data-stock="${f.dataset.stock}">${f.text}</option>`).join("")}
                    </select>
                </td>
                <td>
                    <input type="number" name="items[${t}][quantity]" value="1" min="1" class="item-quantity">
                </td>
                <td>
                    <button type="button" class="btn-remove-item">Eliminar</button>
                </td>
            `,e.appendChild(r)}),document.addEventListener("click",function(e){e.target.classList.contains("btn-remove-item")&&document.querySelectorAll("#items-table tbody tr").length>1&&e.target.closest("tr").remove()}),u&&u.addEventListener("click",function(){u.disabled=!0,u.textContent="Procesando...",fetch(`/pedidos/${d}/complete`,{method:"PATCH",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.ok?e.json():e.text().then(t=>{throw new Error(`Error HTTP: ${e.status} - ${t}`)})).then(e=>{if(e.success){const t=o==null?void 0:o.querySelector(".status-cell"),r=o==null?void 0:o.querySelector("td:last-child");t&&(t.textContent="Completado"),r&&(r.innerHTML=`<button class="btn-detalles" data-id="${d}" aria-label="Ver detalles del pedido #${d}">Ver Detalles</button>`),a&&a.close(),p(e.success)}else s(e.error||"No se pudo completar el pedido.")}).catch(e=>{console.error("Error:",e),s("Hubo un problema: "+e.message)}).finally(()=>{u&&(u.disabled=!1,u.textContent="Sí")})}),m&&m.addEventListener("click",function(){m.disabled=!0,m.textContent="Procesando...",fetch(`/pedidos/${d}/cancel`,{method:"PATCH",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.ok?e.json():e.text().then(t=>{throw new Error(`Error HTTP: ${e.status} - ${t}`)})).then(e=>{if(e.success){const t=o==null?void 0:o.querySelector(".status-cell"),r=o==null?void 0:o.querySelector("td:last-child");t&&(t.textContent="Cancelado"),r&&(r.innerHTML=`<button class="btn-detalles" data-id="${d}" aria-label="Ver detalles del pedido #${d}">Ver Detalles</button>`),n&&n.close(),p(e.success)}else s(e.error||"No se pudo cancelar el pedido.")}).catch(e=>{console.error("Error:",e),s("Hubo un problema al cancelar el pedido: "+e.message)}).finally(()=>{m&&(m.disabled=!1,m.textContent="Sí")})}),y&&a&&y.addEventListener("click",()=>a.close()),b&&n&&b.addEventListener("click",()=>n.close()),g&&l&&g.addEventListener("click",()=>l.close()),C&&i&&C.addEventListener("click",()=>i.close())});function L(a){fetch(`/pedidos/${a}`,{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"text/html"}}).then(n=>{if(!n.ok)throw new Error("Error HTTP: "+n.status);return n.text()}).then(n=>{document.getElementById("detailsContent").innerHTML=n,document.getElementById("pdfLink").href=`/pedidos/${a}/pdf`;const l=document.getElementById("detailsModal");l&&l.showModal()}).catch(n=>{console.error("Error al cargar detalles:",n);const l=document.getElementById("mensaje-error"),i=document.getElementById("dialog-error");l&&i&&(l.textContent="Error al cargar los detalles del pedido: "+n.message,i.showModal())})}
